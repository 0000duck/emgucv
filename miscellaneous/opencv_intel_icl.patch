Index: CMakeLists.txt
===================================================================
--- CMakeLists.txt	(revision 5265)
+++ CMakeLists.txt	(working copy)
@@ -643,31 +643,38 @@
             elseif (UNIX)
                 set(OPENCV_LINKER_LIBS ${OPENCV_LINKER_LIBS} tbb)
             elseif (WIN32)
-                if (CMAKE_COMPILER_IS_GNUCXX)
-                    set(TBB_LIB_DIR "${TBB_INCLUDE_DIR}/../lib" CACHE PATH "Full path of TBB library directory")
-                    link_directories("${TBB_LIB_DIR}")
-                    set(OPENCV_LINKER_LIBS ${OPENCV_LINKER_LIBS} tbb)
-                else()
-                    get_filename_component(_TBB_LIB_PATH "${TBB_INCLUDE_DIR}/../lib" ABSOLUTE)                          
-                   
-                    if(${CMAKE_SYSTEM_PROCESSOR} MATCHES amd64*|x86_64*)
-                        set(_TBB_LIB_PATH "${_TBB_LIB_PATH}/intel64")
-                    endif()                   
-                    if(${CMAKE_SYSTEM_PROCESSOR} MATCHES x86*|i386*|i686*)
-                        set(_TBB_LIB_PATH "${_TBB_LIB_PATH}/ia32")
-                    endif()
+				if (CMAKE_COMPILER_IS_GNUCXX)
+					set(TBB_LIB_DIR "${TBB_INCLUDE_DIR}/../lib" CACHE PATH "Full path of TBB library directory")
+					link_directories("${TBB_LIB_DIR}")
+					set(OPENCV_LINKER_LIBS ${OPENCV_LINKER_LIBS} tbb)
+				else()
+				    get_filename_component(_TBB_LIB_PATH "${TBB_INCLUDE_DIR}/../lib" ABSOLUTE)                         	
+				    if (MSVC)
+                       if(CMAKE_CL_64)
+                         set(_TBB_LIB_PATH "${_TBB_LIB_PATH}/intel64")
+                       else()
+                         set(_TBB_LIB_PATH "${_TBB_LIB_PATH}/ia32")
+                       endif()
+                    else()
+					  if(${CMAKE_SYSTEM_PROCESSOR} MATCHES amd64*|x86_64*)
+						set(_TBB_LIB_PATH "${_TBB_LIB_PATH}/intel64")
+                      endif()                   
+                      if(${CMAKE_SYSTEM_PROCESSOR} MATCHES x86*|i386*|i686*)
+						set(_TBB_LIB_PATH "${_TBB_LIB_PATH}/ia32")
+					  endif()
+					endif()
 
-                    if (MSVC80)
-                       set(_TBB_LIB_PATH "${_TBB_LIB_PATH}/vc8")
-                    elseif(MSVC90)
-                       set(_TBB_LIB_PATH "${_TBB_LIB_PATH}/vc9")                    
-                    elseif(MSVC10)
-                        set(_TBB_LIB_PATH "${_TBB_LIB_PATH}/vc10")
-                    endif()
-                    set(TBB_LIB_DIR "${_TBB_LIB_PATH}" CACHE PATH "Full path of TBB library directory")
-                    link_directories("${TBB_LIB_DIR}")
-                endif()
-            endif()
+					if (MSVC80)
+					   set(_TBB_LIB_PATH "${_TBB_LIB_PATH}/vc8")
+					elseif(MSVC90)
+					   set(_TBB_LIB_PATH "${_TBB_LIB_PATH}/vc9")					
+					elseif(MSVC10)
+						set(_TBB_LIB_PATH "${_TBB_LIB_PATH}/vc10")
+					endif()
+					set(TBB_LIB_DIR "${_TBB_LIB_PATH}" CACHE PATH "Full path of TBB library directory")
+					link_directories("${TBB_LIB_DIR}")
+				endif()
+			endif()
 
             set(HAVE_TBB 1)
             if(NOT "${TBB_INCLUDE_DIR}" STREQUAL "")
Index: modules/gpu/CMakeLists.txt
===================================================================
--- modules/gpu/CMakeLists.txt	(revision 5265)
+++ modules/gpu/CMakeLists.txt	(working copy)
@@ -35,12 +35,12 @@
 endif()
 
 if (HAVE_CUDA)		
-    #get_filename_component(_path_to_findnpp "${CMAKE_CURRENT_LIST_FILE}" PATH)
-    #set(CMAKE_MODULE_PATH ${CMAKE_MODULE_PATH} ${_path_to_findnpp})
-    #find_package(NPP 3.2.16 REQUIRED)
-    #message(STATUS "NPP detected: " ${NPP_VERSION})
+    get_filename_component(_path_to_findnpp "${CMAKE_CURRENT_LIST_FILE}" PATH)
+    set(CMAKE_MODULE_PATH ${CMAKE_MODULE_PATH} ${_path_to_findnpp})
+    find_package(NPP 3.2.16 REQUIRED)
+    message(STATUS "NPP detected: " ${NPP_VERSION})
        
-    include_directories(${CUDA_INCLUDE_DIRS})
+    include_directories(${CUDA_INCLUDE_DIRS} ${CUDA_NPP_INCLUDES})
 
     if (UNIX OR APPLE)
         set (CUDA_NVCC_FLAGS ${CUDA_NVCC_FLAGS}  "-Xcompiler;-fPIC;")
@@ -128,12 +128,8 @@
 target_link_libraries(${the_target} ${OPENCV_LINKER_LIBS} ${IPP_LIBS} ${DEPS} )
 
 if (HAVE_CUDA)
-	target_link_libraries(${the_target} ${CUDA_LIBRARIES})    
+	target_link_libraries(${the_target} ${CUDA_LIBRARIES} ${CUDA_NPP_LIBRARIES})    
     CUDA_ADD_CUFFT_TO_TARGET(${the_target})
-	
-	unset(CUDA_npp_LIBRARY CACHE)
-	find_cuda_helper_libs(npp)
-	target_link_libraries(${the_target} ${CUDA_npp_LIBRARY})    		
 endif()
 
 if(MSVC)
Index: modules/highgui/include/opencv2/highgui/highgui_c.h
===================================================================
--- modules/highgui/include/opencv2/highgui/highgui_c.h	(revision 5265)
+++ modules/highgui/include/opencv2/highgui/highgui_c.h	(working copy)
@@ -404,6 +404,9 @@
 // Return the type of the capturer (eg, CV_CAP_V4W, CV_CAP_UNICAP), which is unknown if created with CV_CAP_ANY
 CVAPI(int)    cvGetCaptureDomain( CvCapture* capture);  
 
+// Return a pointer to the xn::Context of OpenNI from the CvCapture)
+CVAPI(void*) cvGetOpenniCaptureContext( CvCapture* capture);
+
 /* "black box" video file writer structure */
 typedef struct CvVideoWriter CvVideoWriter;
 
Index: modules/highgui/src/cap_openni.cpp
===================================================================
--- modules/highgui/src/cap_openni.cpp	(revision 5265)
+++ modules/highgui/src/cap_openni.cpp	(working copy)
@@ -97,6 +97,8 @@
 
     bool isOpened() const;
 
+    xn::Context* getOpenNIContext() { return &context; }
+
 protected:
     struct OutputMap
     {
@@ -637,4 +639,10 @@
     return 0;
 }
 
+// Return a pointer to the xn::Context of OpenNI from the CvCapture)
+void* cvGetOpenniCaptureContext( CvCapture* capture)
+{
+   CvCapture_OpenNI* openniCapture = (CvCapture_OpenNI*) capture;
+   return openniCapture->getOpenNIContext();
+}
 #endif
Index: modules/legacy/src/3dtracker.cpp
===================================================================
--- modules/legacy/src/3dtracker.cpp	(revision 5265)
+++ modules/legacy/src/3dtracker.cpp	(working copy)
@@ -331,7 +331,7 @@
     int i;
     int x, y;
     CvPoint prev_pt = { 0, 0 };
-    static const CvScalar rgb_colors[] = {
+    static CvScalar rgb_colors[] = {
         {{0,0,255}},
         {{0,128,255}},
         {{0,200,200}},
@@ -339,10 +339,10 @@
         {{200,200,0}},
         {{255,0,0}},
         {{255,0,255}} };
-    static const CvScalar gray_colors[] = {
+    static CvScalar gray_colors[] = {
         {{80}}, {{120}}, {{160}}, {{200}}, {{100}}, {{140}}, {{180}}
     };
-    const CvScalar* colors = img->nChannels == 3 ? rgb_colors : gray_colors;
+    CvScalar* colors = img->nChannels == 3 ? rgb_colors : gray_colors;
 
     CvScalar color = colors[0];
     for (y = 0, i = 0; y < etalon_size.height; y++)
Index: OpenCVFindOpenNI.cmake
===================================================================
--- OpenCVFindOpenNI.cmake	(revision 5265)
+++ OpenCVFindOpenNI.cmake	(working copy)
@@ -42,7 +42,7 @@
     endif()
 endif()
 
-find_library(OPENNI_LIBRARY "OpenNI" PATHS ${OPENNI_LIB_DIR} DOC "OpenNI library" NO_DEFAULT_PATH)
+find_library(OPENNI_LIBRARY "OpenNI" "openNI64" PATHS ${OPENNI_LIB_DIR} DOC "OpenNI library" NO_DEFAULT_PATH)
 find_path(OPENNI_INCLUDES "XnCppWrapper.h" PATHS ${OPENNI_INCLUDE_DIR} DOC "OpenNI c++ interface header" NO_DEFAULT_PATH)
 
 if(OPENNI_LIBRARY AND OPENNI_INCLUDES)
@@ -50,6 +50,9 @@
     # the check: are PrimeSensor Modules for OpenNI installed?
     if(WIN32)
         find_file(OPENNI_PRIME_SENSOR_MODULE "XnCore.dll" PATHS ${OPENNI_PRIME_SENSOR_MODULE_BIN_DIR} DOC "Core library of PrimeSensor Modules for OpenNI" NO_DEFAULT_PATH)
+		if(NOT OPENNI_PRIME_SENSOR_MODULE)
+		    find_file(OPENNI_PRIME_SENSOR_MODULE "XnCore64.dll" PATHS ${OPENNI_PRIME_SENSOR_MODULE_BIN_DIR} DOC "Core library of PrimeSensor Modules for OpenNI" NO_DEFAULT_PATH)
+		endif()
     elseif(UNIX OR APPLE)
         find_library(OPENNI_PRIME_SENSOR_MODULE "XnCore" PATHS ${OPENNI_PRIME_SENSOR_MODULE_BIN_DIR} DOC "Core library of PrimeSensor Modules for OpenNI" NO_DEFAULT_PATH)
     endif()
